@{
	ViewData["Title"] = "Chi Tiết Sản Phẩm";
	var allReviews = (List<Comment>)ViewBag.Reviews;
}
@model ProductDetailVM
@if (TempData["Error"] != null) {
	<div class="alert alert-danger">@TempData["Error"]</div>
}
<!-- back to top button-->
<a href="#" class="cd-top">Back To Top</a>
<!--End Back to top button-->
<!-- Start Banner Area -->
<section class="banner-area organic-breadcrumb">
	<div class="container">
		<div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
			<div class="col-first">
				<h1>Chi tiết sản phẩm</h1>
				<nav class="d-flex align-items-center">
					<a asp-controller="Home" asp-action="Index">Trang chủ<span class="lnr lnr-arrow-right"></span></a>
					<a asp-controller="Product" asp-action="List">>Danh sách sản phẩm<span class="lnr lnr-arrow-right"></span></a>
					<a asp-controller="Product" asp-action="Detail">chi tiết sản phẩm</a>
				</nav>
			</div>
		</div>
	</div>
</section>
<!-- End Banner Area -->
<!--================Single Product Area =================-->
<div class="product_image_area">
	<div class="container">
		<div class="row s_product_inner">
			<div class="col-lg-6">
				@* <div class="single-prd-item">
					<img class="img-fluid" src="../../../img/product/Nam/Boots/b1.1.png" alt="">
				</div>
				<div class="single-prd-item">
					<img class="img-fluid" src="../../../img/product/Nam/Boots/b1.2.png" alt="">
				</div>
				<div class="single-prd-item">
					<img class="img-fluid" src="../../../img/product/Nam/Boots/b1.3.png" alt="">
				</div> *@
				<div class="s_Product_carousel owl-carousel">

					@foreach (var img in Model.Images) {
						<div class="single-prd-item
	                d-flex
	                align-items-center
	                justify-content-center">

							<img src="/@img.UrlImage"
									 class="img-fluid product-img"
									 alt="@Model.Product.NameProduct" />
						</div>
					}

				</div>

			</div>
			<div class="col-lg-5 offset-lg-1">
				<div class="s_product_text">
					<h3>@Model.Product.NameProduct</h3>
					<h2 id="price">@Model.Price.ToString("N0") đ</h2>
					<ul class="list">
						<li><a><span>Thương hiệu</span> : @Model.Product.Trademark?.NameTrademark</a></li>
						<li><a class="active" asp-controller="Category" asp-action="Index"><span>Phân loại</span> : @Model.Product.Category?.NameCategory</a></li>
						<li>
							<a>
								<span>Số lượng tồn</span> :
								<span id="stock-count" class="ml-2 text-success">
									@Model.Quanlity
								</span>
							</a>
						</li>
						<li>
							<a>
								<span>Tình trạng</span> :
								<span id="stock-status"
											class="@(Model.Quanlity > 0 ? "text-success" : "text-danger")">
									@(Model.Quanlity > 0 ? "Còn hàng" : "Hết hàng")
								</span>

							</a>
						</li>
					</ul>
					<p>
						@Model.Product.Descriptions
					</p>
					<div class="noname align-items-center">
						<div class="pb-2"><label>Chọn phiên bản:</label></div>
						<div class="default-select pb-2">
							<select id="variantSelect">
								@foreach (var v in Model.Variants) {
									<option value="@v.VariantId">
										@v.Size.Scale - @v.Color.ColorName
									</option>
								}
							</select>
						</div>



						<div class="pb-1 pt-2"><label for="qty">Số lượng:</label></div>
						<div class="product_count">
							<input type="text" name="qty" id="sst" maxlength="12" value="1" title="Quantity:" class="input-text qty">

							<button onclick="var result = document.getElementById('sst'); var sst = result.value; var stock = parseInt($('#stock-count').text()); if(!isNaN(sst) && sst < stock) result.value++; updateHiddenQty(); return false;"
											class="increase items-count" type="button">
								<i class="lnr lnr-chevron-up"></i>
							</button>

							<button onclick="var result = document.getElementById('sst'); var sst = result.value; if(!isNaN(sst) && sst > 1) result.value--; updateHiddenQty(); return false;"
											class="reduced items-count" type="button">
								<i class="lnr lnr-chevron-down"></i>
							</button>
						</div>
					</div>
					<br>
					<div class="card_area d-flex align-items-center">
						<form asp-controller="Cart" asp-action="AddToCartAndRedirect" method="post">
							<input type="hidden" name="variantId" id="hiddenVariantId" value="@Model.SelectedVariantId" />
							<input type="hidden" name="quantity" id="hiddenQuantity" value="1" />

							<div class="card_area d-flex align-items-center">
								<button type="submit" class="primary-btn" style="border:none;">Thêm vào giỏ hàng</button>

								@* Các nút Wishlist và View giữ nguyên *@
								<a class="icon_btn btn-wishlist" href="javascript:void(0);">
									<i class="lnr lnr-heart"></i>
									<span class="ml-1">@Model.TotalWishlist</span>
								</a>
								<a class="icon_btn" href="javascript:void(0);">
									<i class="lnr lnr-eye"></i>
									<span class="ml-1">@Model.TotalViews</span>
								</a>
							</div>
						</form>

					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!--================End Single Product Area =================-->
<!--================Product Description Area =================-->
<section class="product_description_area">
	<div class="container">
		<ul class="nav nav-tabs" id="myTab" role="tablist">
			<li class="nav-item">
				<a class="nav-link" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Mô tả sản phẩm</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile"
					 aria-selected="false">Chính sách đổi trả</a>
			</li>
			<li class="nav-item">
				<a class="nav-link active" id="review-tab" data-toggle="tab" href="#review" role="tab" aria-controls="review"
					 aria-selected="false">Nhận xét</a>
			</li>
		</ul>
		<div class="tab-content" id="myTabContent">
			<div class="tab-pane fade" id="home" role="tabpanel" aria-labelledby="home-tab">
				<p>
					@Model.Product.Descriptions
				</p>

			</div>
			<div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
				<div class="policy-content p-3">

					<p>
						<b>1. Quy định chung</b><br>
						Tại <b>Minicar</b>, chúng tôi cam kết mang đến những sản phẩm mô hình chất lượng nhất. Tuy nhiên, nếu sản phẩm gặp lỗi từ nhà sản xuất hoặc hư hỏng trong quá trình vận chuyển, chúng tôi sẵn sàng hỗ trợ đổi trả theo quy định.
					</p>

					<p>
						<u><b>Điều kiện đổi trả:</b></u> <br>
						* Sản phẩm còn nguyên bao bì, hộp và các phụ kiện đi kèm (nếu có).<br>
						* Sản phẩm chưa qua sử dụng, không có dấu hiệu tháo lắp hoặc can thiệp kỹ thuật.<br>
						* Có hóa đơn mua hàng hoặc thông tin đơn hàng trên hệ thống.
					</p>

					<p>
						<b>2. Thời hạn đổi trả</b><br>
						* <b>Lỗi do nhà sản xuất (Sơn, chi tiết lắp ráp):</b> Đổi mới trong vòng 03 ngày kể từ khi nhận hàng.<br>
						* <b>Hư hỏng do vận chuyển (Gãy, vỡ):</b> Quý khách vui lòng phản hồi ngay trong vòng 24h sau khi nhận hàng (kèm video mở hộp).
					</p>

					<p>
						<b>3. Chi phí vận chuyển cho việc đổi hàng</b><br>
						* <b>Hàng lỗi/Giao sai mẫu:</b> Minicar chịu 100% phí vận chuyển hai chiều.<br>
						* <b>Đổi theo nhu cầu (Đổi mẫu/size):</b> Khách hàng thanh toán phí vận chuyển hai chiều và chênh lệch giá trị sản phẩm (nếu có).
					</p>

					<p>
						<b>4. Địa chỉ và Thông tin liên hệ</b><br>
						Để thực hiện đổi trả, quý khách vui lòng liên hệ hoặc gửi hàng về:<br>
						<b>Email:</b> minicarmodel@gmail.com<br>
						<b>Hotline tư vấn:</b> 0333854516<br>
						<b>Website:</b> www.minicar.com.vn<br>
						<b>Facebook:</b> www.facebook.com/minicar
					</p>

					<p>
						<b>5. Thời gian xử lý</b><br>
						Sau khi nhận được hàng gửi về, Minicar sẽ kiểm tra và thực hiện gửi lại sản phẩm mới hoặc hoàn tiền trong vòng <b>3 - 5 ngày làm việc</b>.
					</p>

					<p><i>* Lưu ý: Đối với các sản phẩm mô hình phiên bản giới hạn (Limited), việc đổi hàng sẽ tùy thuộc vào tình trạng tồn kho thực tế.</i></p>
				</div>
			</div>
			<div class="tab-pane fade show active" id="review" role="tabpanel">
				<div class="row">
					<div class="col-lg-6">
						<div class="row total_rate">
							<div class="col-6">
								<div class="box_total text-center">
									<h5>Đánh giá chung</h5>
									@* Tính trung bình sao từ danh sách reviews *@
									<h4>@(allReviews.Any() ? ((double)allReviews.Average(r => r.Rating)).ToString("0.0") : "5.0")</h4>
									<h6>(@allReviews.Count Nhận xét)</h6>
								</div>
							</div>
							<div class="col-6">
								<div class="rating_list">
									<ul class="list">
										@for (int i = 5; i >= 1; i--) {
											<li>
												<a href="#">
													@i sao <i class="fa fa-star"></i>
													@allReviews.Count(r => r.Rating == i)
												</a>
											</li>
										}
									</ul>
								</div>
							</div>
						</div>

						<div class="review_list mt-4">
							@foreach (var review in allReviews) {
								<div class="review_item mb-3">
									<div class="media">
										<div class="media-body ml-3">
											@* Lấy NameAccount từ bảng Account đã Include *@
											<h4>@review.Account?.NameAccount</h4>
											@for (int s = 1; s <= 5; s++) {
												<i class="fa fa-star @(s <= review.Rating ? "text-warning" : "text-secondary")"></i>
											}
											<small class="text-muted ml-2">@review.CreateAt</small>
										</div>
									</div>
									<p class="mt-2">@review.Content</p>
								</div>
							}
						</div>
					</div>

					<div class="col-lg-6">
						<div class="review_box p-4 border rounded">
							@if (ViewBag.CanReview == true) {
								<h4>Gửi nhận xét của bạn</h4>
								<form asp-action="SubmitReview" asp-controller="Product" method="post">
									@* Lấy VariantId từ phiên bản hiện tại hoặc qua JavaScript cập nhật *@
									<input type="hidden" name="variantId" id="reviewVariantId" value="@Model.SelectedVariantId" />

									<div class="mb-3">
										<label>Đánh giá của bạn:</label>
										<select name="rating" class="form-control">
											<option value="5">5 Sao - Tuyệt vời</option>
											<option value="4">4 Sao - Tốt</option>
											<option value="3">3 Sao - Bình thường</option>
											<option value="2">2 Sao - Kém</option>
											<option value="1">1 Sao - Tệ</option>
										</select>
									</div>

									<div class="mb-3">
										<textarea class="form-control" name="content" rows="4" placeholder="Nhận xét của bạn..." required></textarea>
									</div>

									<div class="text-right">
										<button type="submit" class="primary-btn border-0">Gửi đánh giá ngay</button>
									</div>
								</form>
							} else {
								<div class="alert alert-info">
									Bạn cần mua và nhận hàng thành công để có thể đánh giá sản phẩm này.
								</div>
							}
						</div>
					</div>
				</div>
			</div>
		</div>
</section>
<script>
		$(document).ready(function () {
			// Cập nhật giá trị vào form ẩn khi người dùng thay đổi lựa chọn
			$('#variantSelect').on('change', function() {
					$('#hiddenVariantId').val($(this).val());
			});

			// Cập nhật số lượng khi bấm nút tăng/giảm
			$('.items-count').on('click', function() {
					setTimeout(function() {
							$('#hiddenQuantity').val($('#sst').val());
					}, 50);
			});
	});

	function updateHiddenQty() {
				$('#hiddenQuantity').val($('#sst').val());
		}

		$(document).ready(function () {
				// Khi đổi phiên bản (Size/Màu), cập nhật lại VariantId và reset số lượng về 1
				$('#variantSelect').on('change', function() {
						$('#hiddenVariantId').val($(this).val());
						$('#sst').val(1);
						$('#hiddenQuantity').val(1);
				});

				// Kiểm tra thủ công nếu người dùng tự nhập số vào ô input
				$('#sst').on('change', function() {
						var stock = parseInt($('#stock-count').text());
						var val = parseInt($(this).val());
						if (val > stock) {
								alert("Số lượng tồn kho không đủ!");
								$(this).val(stock);
						}
						if (val < 1 || isNaN(val)) $(this).val(1);
						updateHiddenQty();
				});
		});
</script>
<script src="~/js/variant_select.js"></script>